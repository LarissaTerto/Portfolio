title: "CursoR - Introdução à análise de dados no R"
author: 'Autor: Wasim Aluísio Prates Syed (@wasimvacinas)'

```{r paged.print=TRUE}
# Baixar pacotes do CRAN para a biblioteca 
install.packages("tidyverse")
install.packages("skimr")
install.packages("janitor")
install.packages("esquisse")
install.packages("ggthemes")
install.packages("plotly")
install.packages("gghighlight")
install.packages("patchwork")
install.packages("ggsci")
install.packages("gapminder")
install.packages("here")
install.packages("gganimate")
install.packages("scales")
install.packages("GGally")
install.packages("ggpmisc")

library(tidyverse) #Metapacote 
library(skimr) #Diagnóstico de tabela
library(janitor) #Limpeza de tabelas
library(esquisse) #Plotagem de gráficos prática
library(ggthemes) #Temas de ggplot
library(plotly) #Gráficos interativos
library(patchwork) #Unir gráficos
library(gghighlight) #Marcar pontos e linhas 
library(ggsci) #Paleta de cores 
library(gapminder) #Dataset sobre população, PIB e expectativa de vida dos países
library(ggpmisc) 
library(scales)
library(here)
library(gganimate)
library(GGally)
```
## Dataframes e tibbles

```{r paged.print=TRUE}
#Dataframes e tibbles -----

#Dataframe
data = data.frame(
  gene = c("Gene1", "Gene2", "Gene3", "Gene4"),
  variavel1 = c(1.59, 1.60, 1.78, 1.73),
  variavel2 = c(30, 25, 31, 32)
)
data
```

```{r}
#Tibble
tibble = tribble(
  ~gene, ~variavel1, ~variavel2,
  "Gene1", 1.59,   30,
  "Gene2",   1.60,   25,
  "Gene3", 1.65,  31,
  "Gene4",   1.73,   32 
  )

tibble
```

```{r}
#Visualizando o dataframe -----
# Com print()
print(data) #No documento ou console
print(tibble)

# Com nome do objeto
data
tibble 

# Com glimpse(). #Descrição mais completa da tabela
glimpse(data) 
glimpse(tibble)

# Com view() ou View(). A tabela completa com mais funcionalidades (filtragem manual, pesquisa e ordenamento) abrirá em uma nova janela
view(data) 
view(tibble)

# Selecione o nome do objeto, segure Ctrl e clique com o botão direito do mouse.
data
tibble 
```

## Estatísticas gerais da tabela

```{r}
# Estatísticas gerais 
summary(tibble)
summary(data)

# Usando skim
skim(tibble)
skim(data)

```

## Pivotando tabelas: Long e Wide

```{r}
# Trabalhando com dataframes -----
#Transformando outros formatos em dataframe

# Long table
data_long = pivot_longer(data, #Tabela 
             cols = c(variavel1, variavel2), #Colunas para alongar 
             values_to = "valor", # Estocar valores em uma nova coluna
             names_to = "variavel" # Estocar variáveis em uma nova coluna
             ) 
data
data_long
```

```{r}
# Wide table
data_wide = pivot_wider(data_long, #Tabela
            names_from = variavel, #Dividir níveis de uma coluna em novas colunas
            values_from = valor)   #Estocar valores relacionados à coluna nome 
                                   #e novas variáveis) 
data_wide
```

## Matrizes

```{r}
#Matriz
matrix = as.matrix(data) #Transformar tabela em matriz
matrix #Os valores numéricos são strings

data_matrix = column_to_rownames(data, "gene") #Converte coluna em rownames
matrix = as.matrix(data_matrix)
matrix #Agora, os valores são numéricos

```


```{r}
# Reconverter para dataframe
matrix_dr = as.data.frame(matrix)

matrix_dr # Coluna "nome" continua como rownames e dificulta a manipulação.

matrix_dr = rownames_to_column(matrix_dr, "gene") #Converter rownames em nova coluna
matrix_dr
```

## Listas

```{r}
#Criando a lista
lista = list(data, matrix, tibble)

#View(lista) #Visualizando a lista

#Acessando objetos diferentes da lista
lista[[1]] #Primeiro objeto
lista[[3]] #Oitavo objeto

#Isolando o objeto
df_list = lista[[3]]
df_list

```

## Manipulação de tabelas com o R base

```{r}
# Acessando colunas do data frame
data$gene
data$variavel1

```

```{r}

# Criando nova variável para não sobrescrever a tabela original para os próximos exemplos
data_2 = data

# Adicionando uma nova coluna ao data frame
data_2$variavel3 = c(70,
                     65,
                     80,
                     20)
data_2

```

```{r}
# Removendo uma coluna do data frame
data_3 = data_2[ , -4]
```

```{r}
# Filtrando linhas do data frame. df[linha, coluna]
data_jovens = data_2[data_2$variavel3 < 30, ]
data_jovens

# Ordenando o data frame por uma coluna
data_ordenados <- data_2[order(data_2$variavel3), ]
data_ordenados
```

# 3. Tidyverse
## `filter():` Filtrando linhas e usando o pipe

```{r paged.print=TRUE}
# Filtrando linhas ----
variavel2 = filter(data, variavel2 <= 30)

gene_variavel2 = filter(variavel2,
                    gene == "Gene1")

gene_variavel2
```

```{r paged.print=TRUE}
#Usando OU (|)
filter(data, gene == "Gene1" | 
           gene == "Gene3")

#Usando %in% c()
filter(data, gene %in% c("Gene1", "Gene2")) 

```

```{r paged.print=TRUE}
# Usando o pipe "%>%" (lê-se "e então")
data %>%                   # Tenho este objeto 
  filter(variavel2 >= 30) %>%  # E então vou filtrar os indivíduos com mais de 30 anos
  filter(gene == "Gene1")   # E então vou filtrar os indivíduos chamados "Gabriela"
```

## `select():` Selecionando colunas

```{r paged.print=TRUE}
# Selecionando colunas ----
# Selecionar colunas específicas
data_2 %>%
  select(gene, variavel1) 

# Selecionar da coluna gene (1) à coluna variavel2 (3)
data_2 %>% 
  select(gene:variavel2) 

data_2 %>%   
  select(!variavel2)

#Reordenando coluna
data_2 %>%   
  select(variavel2, everything())

```

```{r paged.print=TRUE}
#Renomeando coluna com rename
data_2 %>%   
  rename(expression = variavel1) #Retirando coluna
```

## `mutate():` Criando e realizando operações com novas variáveis

```{r paged.print=TRUE}
# Criando novas variáveis
data_2 = data_2 %>%
  mutate(factor = variavel2 / (variavel1^2)) #Para cada linha da tabela, 
                                  #pegaremos o valor da variavel2 e dividiremos 
                                  #pela variavel1 ao quadrado.

```

```{r paged.print=TRUE}
data_2 %>% 
  mutate(species = "human") #Como todas as linhas contêm nomes 
                            #femininos, criaremos a coluna species 
                            #com o valor "human"
```

## `if_else` e `case_when()`: Condições

```{r paged.print=TRUE}
data_2 %>% 
  mutate(classification = if_else(factor > 10, "super", "normal"))
```

```{r paged.print=TRUE}
data_2 = data_2 %>% 
  mutate(classification = case_when(factor >= 11 ~ "super",
                                   factor > 10 & factor < 11 ~ "normal",
                                   factor < 10 ~ "under"))
```

## summarize(): resumindo estatísticas

```{r paged.print=TRUE}
# Resumindo dados
data_2 %>% 
  summarize(mean = mean(variavel1))

data_2 %>% 
  summarize(sum = sum(variavel1))
```

## `group_by`: Agrupando dados

```{r paged.print=TRUE}
#Média dos grupos
data_2 %>% 
  group_by(classification) %>% 
  summarize(mean = mean(variavel2))

#Contagem
data_2 %>% 
  group_by(classification) %>% 
  summarize(n = n())
```

## `arrange():` Ordenando dados

```{r paged.print=TRUE}
# Ordenando dados de forma crescente
data_2 %>% 
  arrange(variavel1)

# Ordenando de forma decrescente
#Método 1
data_2 %>% 
  arrange(desc(variavel1))

#Método 2
data_2 %>% 
  arrange(-variavel1)
```

## Joins: merging/unindo tabelas

```{r paged.print=TRUE}
gene_info = tribble(~gene, ~type, ~process,
          "Gene1", "Pseudogene", "Immune",
          "Gene2", "Protein-coding", "Metabolism",
          "Gene3", "miRNA", "Immune",
          "Gene4", "Protein-coding", "Cellular",
          "Gene5", "Protein-coding", "Regulation")
gene_info
```

```{r paged.print=TRUE}
data_2 %>% #Tabela original (tabela 1)
  inner_join(gene_info, #Tabela para unir (tabela 2)
             by = "gene") #Coluna correspondente
```

```{r paged.print=TRUE}
data_2 %>% #Tabela original (tabela 1)
  left_join(gene_info, #Tabela para unir (tabela 2)
             by = "gene") #Coluna correspondente
```

### anti_join()

```{r paged.print=TRUE}
data_2 %>% #Tabela original (tabela 1)
  anti_join(gene_info, #Tabela para unir (tabela 2)
             by = "gene") #Coluna correspondente

gene_info %>% #Tabela original (tabela 2)
  anti_join(data_2, #Tabela para unir (tabela 1)
             by = "gene") #Coluna correspondente
```

### right_join()

```{r paged.print=TRUE}
data_2 %>% #Tabela original (tabela 1)
  right_join(gene_info, #Tabela para unir (tabela 2)
             by = "gene") #Coluna correspondente
```

### full_join()

```{r paged.print=TRUE}
data_2 %>% #Tabela original (tabela 1)
  full_join(gene_info, #Tabela para unir (tabela 2)
             by = "gene") #Coluna correspondente
```

## Usando o `pipe` para fazer múltiplas operações de uma vez

```{r}
# Múltiplas operações em uma caixa
mega_pipe = data_2 %>% 
  arrange(variavel2) %>% 
  filter(variavel2 >= 30,
         variavel3 >= 50) %>% 
  select(-gene) %>% 
  mutate(factor = round(factor, 1),
         var1_x_var2 = variavel1 * variavel2) %>%
  summarise(mean = mean(variavel2),
            mean = round(mean, 1),
            mean_factor = mean(factor) %>% round(1))
mega_pipe
```

# 4. Visualização

## Gráfico de barras

```{r}
data_2 %>% 
  ggplot() +
  aes(x = gene,
      y = factor) +
  geom_col()
```

```{r}
data_2 %>% 
  ggplot() +
  aes(x = fct_reorder(gene, -factor), #Mapeando variáveis
      y = factor) +
  geom_col() + #Geometria
  theme_minimal() + #Tema 
  labs(x = "Gene", #Títulos
       y = "Factor",
       title = "Factor")
```

```{r}
data_2 %>% 
  ggplot() +
  
  #Mapeando variáveis
  aes(x = fct_reorder(gene, -factor), 
      y = factor) +
  
  #Geometria
  geom_col() + 
  
  #Tema pré-estabelecido
  theme_minimal() + 
  
  #Modificando o tema
  theme(axis.text.x = element_text(size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        plot.title = element_text(size = 12,
                                  color = "black",
                                  hjust = 0.5,
                                  face = "bold")) +
  #Títulos
  labs(x = "Gene", 
       y = "Factor",
       title = "Factor by gene")
```

## Cores

```{r}
data_2 %>% 
  ggplot() +
  
  #Mapeando variáveis
  aes(x = fct_reorder(gene, -factor), 
      y = factor,
      fill = classification) +
  
  #Geometria
  geom_col() + 
  
  #Tema pré-estabelecido
  theme_light() + 
  
  #Modificando o tema
  theme(axis.text.x = element_text(size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        plot.title = element_text(size = 12,
                                  color = "black",
                                  hjust = 0.5,
                                  face = "bold")) +
  #Títulos
  labs(x = "Gene", 
       y = "Factor",
       title = "Factor") +
  
  #Renomeando levels
  scale_fill_discrete(labels = c("under" = "Under", 
                               "normal" = "Normal",
                               "super" = "Super")) 
```

```{r message=FALSE, warning=FALSE}
# Cores
#Mudando a paleta
vignette("ggsci") 

jama = pal_jama("default", #Especificar paleta
              alpha = 0.7)(8) #Gerar 8 cores com transparencia = 70%
jama %>% 
  show_col()
```

```{r}
data_2 %>% 
  ggplot() +
  
  #Mapeando variáveis
  aes(x = fct_reorder(gene, -factor),
      y = gene,
      fill = classification) +
  
  #Adicionando geometrias
  geom_col() +
  
  #Tema pré-estabelecido
  theme_light() + 
  
  #Adicionando títulos
  labs(x = "Gene", 
       y = "Factor",
       title = "Factor",
       fill = "Classification") +
  
  #Modificando o tema
  theme(axis.text.x = element_text(size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        plot.title = element_text(size = 12,
                                  color = "black",
                                  hjust = 0.5,
                                  face = "bold")) +
  
   #Renomeando levels
  scale_fill_discrete(labels = c("under" = "Under", 
                               "normal" = "Normal",
                               "super" = "Super"))  +
  scale_fill_jama()
```

```{r}
barras = data_2 %>% 
  ggplot() +
  aes(x = fct_reorder(gene, -factor),
      y = factor,
      fill = classification) +
  geom_col() +
  labs(x = "Nome", #Títulos
       y = "IMC",
       title = "Índice de massa corporal",
       fill = "Classificação") +
  
  #Tema pré-estabelecido
  theme_light() + 
  
  #Modificando o tema
  theme(axis.text.x = element_text(size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        plot.title = element_text(size = 12,
                                  color = "black",
                                  hjust = 0.5,
                                  face = "bold")) +
  
  #Renomeando levels
  scale_fill_discrete(labels = c("under" = "Under", 
                               "normal" = "Normal",
                               "super" = "Super")) +
  scale_fill_manual(values = c("under" = "red", 
                               "normal" = "blue",
                               "super" = "#ffb703"))

barras
```

## Gráfico de dispersão

```{r}

data_2 %>% 
  ggplot() +
  aes(x = variavel3,
      y = factor,
      color = classification) +
  geom_point() +
  
  #Títulos
    labs(x = "Variável 3", 
       y = "Factor",
       title = "Factor versus Var 3",
       color = "Factor") +
  
  #Tema pré-estabelecido
  theme_light() + 
  
  #Modificando o tema
  theme(axis.text.x = element_text(size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        plot.title = element_text(size = 12,
                                  color = "black",
                                  hjust = 0.5,
                                  face = "bold"))  +
  
  #Cores
  scale_color_jama()
```

Além disso, podemos criar um gradiente usando `scale_color_gradient()` e definindo as cores pros valores mínimo e máximo.

```{r}
data_2 %>% 
  ggplot() +
  aes(x = variavel3,
      y = factor,
      color = factor) +
  geom_point() +
  
  #Títulos
    labs(x = "Variable 3", 
       y = "Factor",
       title = "Factor versus Variable",
       color = "Factor") +
  
  #Tema pré-estabelecido
  theme_light() + 
  
  #Modificando o tema
  theme(axis.text.x = element_text(size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        plot.title = element_text(size = 12,
                                  color = "black",
                                  hjust = 0.5,
                                  face = "bold"))  +
  
  #Gradiente de cores
  scale_color_gradient(low = "yellow", 
                       high = "brown", 
                       na.value = NA)
```

## Adicionando mais geoms


```{r}
linha = data_2 %>% 
  ggplot() +
  
  #Mapping
  aes(x = variavel3,
      y = factor,
      color = factor) +
  
  #Geometriasw
  geom_line(size = 2) +
  geom_point(size = 4) +
  
  #Títulos
    labs(x = "Variable 3", 
       y = "Factor",
       title = "Factor versus Variable 3",
       color = "Factor") +

  #Tema pré-estabelecido
  theme_light() + 
  
  #Modificando o tema
  theme(axis.text.x = element_text(size = 10,
                                   color = "black"),
        axis.text.y = element_text(size = 10,
                                   color = "black"),
        plot.title = element_text(size = 12,
                                  color = "black",
                                  hjust = 0.5,
                                  face = "bold"))  +
  
  #Gradiente de cores
  scale_color_gradient(low = "yellow", 
                       high = "brown", 
                       na.value = NA)

linha
```
## Gráfico interativo: Plotly

```{r message=FALSE, warning=FALSE}
linha %>% 
  ggplotly() 
```

## Visualização rápida com o Esquisse

```{r}
 data_2 %>% 
   esquisser()
```

## Uma figura, mais gráficos

```{r}
linha + barras + plot_layout(guides = "collect")
```

```{r}
linha / barras + plot_layout(guides = "collect")
```

```{r}
linha_barra = linha / barras + plot_layout(guides = "collect")

ggsave(linha_barra, file = here("Figuras","linha_barra.png"), width = 10, height = 5)
```

# Dia 2

# 5. Trabalhando com dados de bioinformática

Importando dados

```{r}
metadata <- read_csv("metadata.csv")
expression_data <- read_csv("expression_data.csv")

```

```{r}
library(janitor)
metadata = metadata %>% 
  clean_names()
```

```{r}
#Transformar em matriz
expression_data_matriz = expression_data %>% 
  column_to_rownames("gene") %>% 
  as.matrix()
expression_data_matriz
```

```{r}
#Transformar em tabela longa
expression_data_long = expression_data %>%
  pivot_longer(cols = -gene,
               names_to = "sample",
               values_to = "value")
```

```{r}
#Unir duas tabelas com anotações
expression_data_long_metadata = expression_data_long %>% 
  inner_join(metadata, by = "sample")
```

```{r eval=FALSE, include=FALSE}
expression_data_long_metadata %>% 
  filter(gene == "Gene_1") %>% 
  esquisser()
```

Histograma

```{r}
library(ggsci)
expression_data_long_metadata %>% 
  filter(gene == "Gene_1") %>%
  ggplot()+
  aes(x = value, fill = condition) +
  geom_point(aes(x = value, color = condition),
             y = -0.1) +
  geom_histogram(bins = 6L) +
  scale_fill_npg() +
  scale_color_npg() +
  theme_classic()
  
```

Gráfico de densidade

```{r}
expression_data_long_metadata %>% 
  filter(gene == "Gene_1") %>%
  ggplot()+
  aes(x = value, fill = condition) +
  geom_density(alpha = 0.8) +
  theme_classic() +
  scale_fill_npg()
```

Boxplot simples

```{r}
expression_data_long_metadata %>% 
  filter(gene == "Gene_1") %>%
  ggplot()+
  aes(x = condition,
      y = value, 
      fill = condition) +
  geom_boxplot() + 
  theme_classic() +
  scale_fill_npg()
```

Boxplot com violing plot e pontos

```{r}
p = expression_data_long_metadata %>% 
  filter(gene == "Gene_1") %>%
  ggplot()+
  aes(x = condition, 
      y = value, 
      fill = condition) +
  geom_violin(alpha = 0.5) +
  geom_boxplot(width = 0.4) +
  geom_point() +
  theme_classic() +
  scale_fill_npg() +
  labs(x = "Condition",
       y = "Expression",
       fill = "Condition",
       title = "Gene 1",
       subtitle = "Gene expression by condition")

p

```

Gráfico de barras com intervalo de confiança 95%

```{r}
table_genes_1_2 = expression_data_long_metadata %>% 
  group_by(condition, gene) %>% 
  summarize(mean = mean(value),
            sd = sd(value),
            n = n(),
            std_error = sd / sqrt(n),
            lower_bound = mean - 1.96 * std_error,
            upper_bound = mean + 1.96 * std_error)

table_genes_1_2 %>% 
  ungroup() %>% 
  filter(gene == "Gene_1") %>%
  ggplot()+
  aes(x = condition, 
      y = mean, 
      fill = condition) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
                width = 0.1) +
  theme_classic() +
  scale_fill_npg()+
  labs(x = "Condition",
       y = "Expression",
       fill = "Condition",
       title = "Gene 1",
       subtitle = "Mean gene expression by condition")

```

Teste t com ggpubr

```{r}
library(ggpubr)
my_comparisons <- list( c("Condition_A", "Condition_B"))
p + 
  stat_compare_means(comparisons = my_comparisons, 
                     method = "t.test")
```

Gráfico de dispersão

```{r}
expression_data_long_metadata %>% 
  filter(gene %in% c("Gene_1", "Gene_2")) %>%
  pivot_wider(names_from = "gene",
              values_from = "value") %>% 
  ggplot()+
  aes(x = Gene_1, 
      y = Gene_2, 
      color = condition) +
  geom_point(size = 3) +
  theme_classic() +
  scale_color_npg() +
  labs(x = "Gene 1",
       y = "Gene 2",
       color = "Condition",
       title = "Gene 1 vs Gene 2",
       subtitle = "Gene expression by condition") +
  theme(legend.position = "top")
```


